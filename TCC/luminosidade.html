<!DOCTYPE html>
<html>
  <body>
    <h1>Luminosidade: <span id="luminosidade">0</span>%</h1>
    <button id="conectar">Conectar ao Arduino</button>

    <script>
      const conectarBtn = document.getElementById("conectar");
      const luminosidadeSpan = document.getElementById("luminosidade");
      let port;
      let buffer = ""; // Buffer para acumular dados recebidos

      async function lerDados() {
        // Verificar se a porta está aberta e se 'readable' está disponível
        if (!port || !port.readable) {
          console.error("A porta serial não está aberta ou não é legível");
          return;
        }

        const reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            // Decodificar os dados recebidos
            const texto = new TextDecoder().decode(value);
            console.log("Recebido:", texto); // Ver se os dados aparecem no console
            luminosidadeSpan.textContent = texto.trim(); // Atualiza o conteúdo do span
          }
        } catch (err) {
          console.error("Erro ao ler dados:", err);
        } finally {
          reader.releaseLock();
        }
      }

      conectarBtn.addEventListener("click", async () => {
        try {
          // Solicitar a porta serial
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });

          console.log("Conectado com sucesso!");

          // Enviar o número 4 para o Arduino
          const writer = port.writable.getWriter();
          const encoder = new TextEncoder();
          const data = encoder.encode('4'); // Envia o número "4"
          await writer.write(data);
          writer.releaseLock();

          // Começar a ler os dados do Arduino (opcional)
          //   await lerDados();
          // Verificar se a porta está aberta e se 'readable' está disponível
          if (!port || !port.readable) {
            console.error("A porta serial não está aberta ou não é legível");
            return;
          }

          const reader = port.readable.getReader();
          try {

            while (true) {
              const { value, done } = await reader.read();
              if (done) break;

              // Decodificar os dados recebidos
              const texto = new TextDecoder().decode(value);
              console.log("Recebido:", texto); // Ver se os dados aparecem no console
              luminosidadeSpan.textContent = texto.trim();
              // luminosidadeSpan.textContent = texto.trim(); // Atualiza o conteúdo do span
            }
          } catch (err) {
            console.error("Erro ao ler dados:", err);
          } finally {
            reader.releaseLock();
          }

          conectarBtn.textContent = "Conectado!";
        } catch (err) {
          alert("Erro: " + err.message);
        }
      });
    </script>
  </body>
</html>
